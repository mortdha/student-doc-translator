<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>الجامعي - عارض PDF المتقدم</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        /* Reset and Base Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow-x: hidden; font-family: 'Segoe UI', Tahoma, Arial, sans-serif; direction: rtl; text-align: right; touch-action: manipulation; }
        .fas, .fa { font-family: 'Font Awesome 6 Free'; font-weight: 900; }
        :root { --primary-color: #667eea; --secondary-color: #764ba2; --accent-color: #ffd700; --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%); --text-color: #333; --text-light: #666; --bg-overlay: rgba(255, 255, 255, 0.95); --border-color: rgba(0,0,0,0.1); --shadow: 0 4px 20px rgba(0, 0, 0, 0.1); }
        body.theme-white { --primary-color: #6c757d; --secondary-color: #495057; --accent-color: #007bff; --bg-gradient: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); --text-color: #212529; --bg-overlay: rgba(255, 255, 255, 0.98); --border-color: rgba(0, 0, 0, 0.1); }
        body.theme-black { --primary-color: #34495e; --secondary-color: #2c3e50; --accent-color: #f39c12; --bg-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); --text-color: #ecf0f1; --bg-overlay: rgba(44, 62, 80, 0.95); --border-color: rgba(255, 255, 255, 0.1); }
        body.theme-blue { --primary-color: #1e3c72; --secondary-color: #2a5298; --accent-color: #00d4ff; --bg-gradient: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); --text-color: #ffffff; --bg-overlay: rgba(30, 60, 114, 0.95); --border-color: rgba(255, 255, 255, 0.2); }
        body.theme-violet { --primary-color: #7f00ff; --secondary-color: #e100ff; --accent-color: #00ffc8; --bg-gradient: linear-gradient(135deg, #7f00ff 0%, #e100ff 100%); --text-color: #ffffff; --bg-overlay: rgba(127, 0, 255, 0.85); --border-color: rgba(255, 255, 255, 0.2); }
        
        /* Base mobile-first layout */
        body.mobile-first .main-container { flex-direction: column; }
        
        /* Tablet side-by-side layout */
        body.tablet-mode .main-container { flex-direction: row; gap: 2rem; }
        body.tablet-mode .pdf-viewer-section { flex: 2; }
        body.tablet-mode #translationPanels { flex: 1.5; }

        /* --- START: NEW DESKTOP/LANDSCAPE MODE --- */
        body.tablet-landscape-mode .main-container {
            flex-direction: column; /* Stack vertically */
            align-items: center; /* Center items horizontally */
            gap: 1.5rem;
        }
        body.tablet-landscape-mode .pdf-viewer-section,
        body.tablet-landscape-mode #translationPanels {
            width: 95%; /* Take up most of the width */
            max-width: 1100px; /* But not too wide on very large screens */
        }
        /* --- END: NEW DESKTOP/LANDSCAPE MODE --- */

        .app-container { min-height: 100vh; background: var(--bg-gradient); display: flex; flex-direction: column; transition: background 0.5s ease; }
        .progress-bar-container { height: 4px; width: 100%; background-color: rgba(255, 255, 255, 0.2); position: fixed; top: 0; left: 0; z-index: 2000; display: none; }
        .progress-bar { height: 100%; width: 0%; background-color: var(--accent-color); transition: width 0.3s ease; }
        .mobile-header { background: var(--bg-overlay); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); padding: 1rem; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow); transition: background 0.5s ease, border-color 0.5s ease; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .app-title { display: flex; align-items: center; gap: 0.5rem; color: var(--text-color); }
        .app-title i { font-size: 1.5rem; color: var(--accent-color); transition: color 0.5s ease; }
        .app-title h1 { font-size: 1.2rem; font-weight: 600; }
        .header-actions { display: flex; gap: 0.5rem; }
        .header-controls { display: flex; gap: 1rem; justify-content: center; }
        .main-container { flex: 1; padding: 1rem; display: flex; gap: 1rem; }
        .pdf-viewer-section { flex: 3; background: var(--bg-overlay); border-radius: 15px; padding: 1rem; box-shadow: var(--shadow); position: relative; min-height: 60vh; transition: background 0.5s ease; display: flex; flex-direction: column;}
        .loading-screen { display: flex; align-items: center; justify-content: center; height: 100%; text-align: center; }
        .loading-content { color: var(--text-color); }
        .loading-icon { font-size: 3rem; color: var(--accent-color); margin-bottom: 1rem; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .loading-content h2 { font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--text-color); }
        .loading-content p { color: var(--text-light); line-height: 1.6; }
        .pdf-viewer { height: 100%; display: flex; flex-direction: column; position: relative; }
        .flipbook-container { flex: 1; display: flex; align-items: center; justify-content: center; background: #f0f0f0; border-radius: 10px; overflow: auto; position: relative; min-height: 400px; }
        body.theme-black .flipbook-container { background: #1e1e1e; }
        .pdf-page { object-fit: contain; border-radius: 5px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); display: block; }
        .touch-controls { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; background: var(--bg-overlay); border-radius: 25px; margin-top: 1rem; box-shadow: var(--shadow); }
        .zoom-controls { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 0.5rem; }
        .control-btn, .btn-icon, .zoom-btn, .action-btn-small, .btn-close { background-color: var(--primary-color); color: white; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .control-btn:hover, .btn-icon:hover, .zoom-btn:hover, .action-btn-small:hover { background-color: var(--secondary-color); transform: scale(1.1); }
        .btn-icon:hover { color: white; }
        .control-btn:disabled, .zoom-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .control-btn { width: 50px; height: 50px; font-size: 1.2rem; }
        .btn-icon { width: 40px; height: 40px; font-size: 1rem; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); color: var(--text-color); }
        .zoom-btn { width: 40px; height: 40px; background: var(--secondary-color); }
        .page-info, .zoom-display { font-weight: 600; color: var(--text-color); background: rgba(255, 255, 255, 0.8); padding: 0.5rem 1rem; border-radius: 20px; }
        .page-info { display: flex; align-items: center; gap: 0.5rem; font-size: 1.1rem; }
        .zoom-display { font-size: 1rem; min-width: 70px; text-align: center; }
        #translationPanels { display: none; flex-direction: column; flex: 2; gap: 0; background: var(--bg-overlay); border-radius: 15px; box-shadow: var(--shadow); overflow: hidden;}
        .translation-panel { padding: 1rem; border: none; box-shadow: none; border-radius: 0;}
        #originalTextPanel { border-top: 1px solid rgba(0,0,0,0.1); }
        body.theme-black #originalTextPanel { border-top-color: rgba(255,255,255,0.1); }
        .panel-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); }
        .panel-header h3 { display: flex; align-items: center; gap: 0.5rem; color: var(--text-color); font-size: 1.1rem; margin: 0; }
        .translated-panel .panel-header h3 i { color: var(--accent-color); }
        .original-panel .panel-header h3 i { color: var(--primary-color); }
        .panel-actions { display: flex; gap: 0.5rem; align-items: center; }
        .action-btn-small { width: 35px; height: 35px; font-size: 0.9rem; }
        .btn-close { width: 35px; height: 35px; font-size: 0.9rem; background: #ff4757; }
        .btn-close:hover { background: #ff3742; transform: scale(1.1); }
        .translation-content { height: calc(100% - 45px); overflow-y: auto; padding: 0.5rem; }
        .notification { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); padding: 12px 20px; border-radius: 25px; color: white; font-size: 1rem; z-index: 1000; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); transition: all 0.3s ease; background-color: var(--primary-color); display: none; }
        .notification.show { display: block; animation: slideUp 0.3s ease; }
        .notification.notification-success { background-color: #28a745; }
        .notification.notification-warning { background-color: #ffc107; color: #212529; }
        .notification.notification-error { background-color: #dc3545; }
        @keyframes slideUp { from { opacity: 0; transform: translateX(-50%) translateY(100%); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        .btn-primary, .btn-secondary { padding: 0.75rem 1.5rem; border-radius: 25px; font-size: 1rem; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 0.5rem; min-height: 50px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); border: none; cursor: pointer; transition: all 0.3s ease; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-secondary { background: var(--secondary-color); color: white; }
        .btn-primary:hover, .btn-primary:active { background: var(--secondary-color); transform: translateY(-2px); }
        .btn-secondary:hover, .btn-secondary:active { background: var(--primary-color); transform: translateY(-2px); }
        .btn-primary:disabled, .btn-secondary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        #translateFullDocBtn.loading { pointer-events: none; }
        #translateFullDocBtn.loading i { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #translatedTextContent .page-translation { margin-bottom: 1.5rem; padding: 1rem; border-radius: 8px; background: rgba(0,0,0,0.02); border-right: none; }
        body.theme-black #translatedTextContent .page-translation { background: rgba(255,255,255,0.04); }
        #translatedTextContent .page-translation h4 { margin-bottom: 0.75rem; color: var(--primary-color); }
        #translatedTextContent .page-translation p { line-height: 1.9; margin-bottom: 1rem; white-space: pre-wrap; word-wrap: break-word; color: var(--text-color); }
        #translatedTextContent { padding-bottom: 2rem; }
        .translated-header { padding-bottom: 1.5rem; margin-bottom: 2rem !important; border-bottom: 1px solid var(--border-color); font-style: italic; opacity: 0.9; }
        
        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
        }
    </style>
</head>
<body class="mobile-first">
    <div class="progress-bar-container"><div class="progress-bar"></div></div>
    <div class="app-container">
        <header class="mobile-header">
            <div class="header-top">
                <div class="app-title"><i class="fas fa-graduation-cap"></i><h1>الجامعي</h1></div>
                <div class="header-actions">
                    <button id="deviceToggle" class="btn-icon" title="تبديل الوضع"><i class="fas fa-mobile-alt"></i></button>
                    <button id="themeToggle" class="btn-icon" title="تغيير اللون"><i class="fas fa-palette"></i></button>
                </div>
            </div>
            <div class="header-controls">
                <button id="loadPdfBtn" class="btn-primary"><i class="fas fa-upload"></i><span>تحميل PDF</span></button>
                <button id="translateFullDocBtn" class="btn-secondary" disabled><i class="fas fa-book"></i><span>ترجمة المستند بالكامل</span></button>
            </div>
        </header>
        <main class="main-container">
            <div class="pdf-viewer-section">
                <div id="loadingMessage" class="loading-screen">
                    <div class="loading-content"><i class="fas fa-graduation-cap loading-icon"></i><h2>مرحباً بك في الجامعي</h2><p>عارض PDF المتقدم للطلاب والباحثين مع ترجمة علمية احترافية</p></div>
                </div>
                <div id="pdfViewer" class="pdf-viewer" style="display: none;">
                    <div id="flipbook" class="flipbook-container"><canvas id="pdf-canvas" class="pdf-page"></canvas></div>
                    <div class="touch-controls">
                        <button id="nextPageBtn" class="control-btn" disabled><i class="fas fa-chevron-left"></i></button>
                        <div class="page-info"><span id="currentPageNum">0</span><span>/</span><span id="totalPagesNum">0</span></div>
                        <button id="prevPageBtn" class="control-btn" disabled><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="zoom-controls">
                        <button id="zoomOutBtn" class="zoom-btn" disabled><i class="fas fa-search-minus"></i></button>
                        <span id="zoomLevel" class="zoom-display">100%</span>
                        <button id="zoomInBtn" class="zoom-btn" disabled><i class="fas fa-search-plus"></i></button>
                    </div>
                </div>
            </div>
            <div id="translationPanels">
                <div class="translation-panel translated-panel">
                    <div class="panel-header">
                        <h3><i class="fas fa-language"></i> الترجمة</h3>
                        <div class="panel-actions"><button id="closeTranslationBtn" class="btn-close" title="إغلاق"><i class="fas fa-times"></i></button></div>
                    </div>
                    <div class="translation-content" id="translatedTextContent"></div>
                </div>
            </div>
        </main>
        <div id="notification" class="notification"><span id="notificationText"></span></div>
    </div>
    <input type="file" id="fileInput" accept=".pdf" style="display: none;">

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let pdfDoc = null, pageNum = 1, pageRendering = false, pageNumPending = null, scale = 1.0, totalPages = 0;
            const themes = ['', 'theme-white', 'theme-black', 'theme-blue', 'theme-violet'];
            let currentThemeIndex = 0;

            // --- START: JAVASCRIPT FOR NEW DISPLAY MODES ---
            const displayModes = ['mobile-first', 'tablet-mode', 'tablet-landscape-mode'];
            const modeIcons = ['fa-mobile-alt', 'fa-tablet-alt', 'fa-laptop'];
            let currentModeIndex = 0;
            // --- END: JAVASCRIPT FOR NEW DISPLAY MODES ---

            const body = document.body, loadPdfBtn = document.getElementById('loadPdfBtn'), fileInput = document.getElementById('fileInput'), loadingMessage = document.getElementById('loadingMessage'), pdfViewer = document.getElementById('pdfViewer'), canvas = document.getElementById('pdf-canvas'), ctx = canvas.getContext('2d'), currentPageNumSpan = document.getElementById('currentPageNum'), totalPagesNumSpan = document.getElementById('totalPagesNum'), prevPageBtn = document.getElementById('prevPageBtn'), nextPageBtn = document.getElementById('nextPageBtn'), zoomInBtn = document.getElementById('zoomInBtn'), zoomOutBtn = document.getElementById('zoomOutBtn'), zoomLevelSpan = document.getElementById('zoomLevel'), translateFullDocBtn = document.getElementById('translateFullDocBtn'), translationPanels = document.getElementById('translationPanels'), translatedTextContent = document.getElementById('translatedTextContent'), closeTranslationBtn = document.getElementById('closeTranslationBtn'), deviceToggle = document.getElementById('deviceToggle'), themeToggle = document.getElementById('themeToggle'), notification = document.getElementById('notification'), notificationText = document.getElementById('notificationText'), progressBarContainer = document.querySelector('.progress-bar-container'), progressBar = document.querySelector('.progress-bar');
            
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js`;

            function renderPage(num) {
                pageRendering = true;
                pdfDoc.getPage(num).then(page => {
                    const devicePixelRatio = window.devicePixelRatio || 1, viewport = page.getViewport({ scale: scale });
                    canvas.height = viewport.height * devicePixelRatio;
                    canvas.width = viewport.width * devicePixelRatio;
                    canvas.style.height = `${viewport.height}px`;
                    canvas.style.width = `${viewport.width}px`;
                    ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
                    page.render({ canvasContext: ctx, viewport: viewport }).promise.then(() => {
                        pageRendering = false;
                        if (pageNumPending !== null) { renderPage(pageNumPending); pageNumPending = null; }
                    });
                });
                currentPageNumSpan.textContent = num;
                updateNavButtons();
            }

            function updateNavButtons() { prevPageBtn.disabled = (pageNum <= 1); nextPageBtn.disabled = (pageNum >= totalPages); }
            function queueRenderPage(num) { if (pageRendering) pageNumPending = num; else renderPage(num); }
            function onPrevPage() { if (pageNum <= 1) return; pageNum--; queueRenderPage(pageNum); }
            function onNextPage() { if (pageNum >= pdfDoc.numPages) return; pageNum++; queueRenderPage(pageNum); }
            function onZoomIn() { if (scale >= 3.0) return; scale = parseFloat((scale + 0.25).toFixed(2)); queueRenderPage(pageNum); zoomLevelSpan.textContent = `${Math.round(scale * 100)}%`; }
            function onZoomOut() { if (scale <= 0.25) return; scale = parseFloat((scale - 0.25).toFixed(2)); queueRenderPage(pageNum); zoomLevelSpan.textContent = `${Math.round(scale * 100)}%`; }
            
            function loadFile(file) {
                const reader = new FileReader();
                reader.onload = e => {
                    const arrayBuffer = e.target.result;
                    const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer, cMapUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.cmaps/', standardFontDataUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/standard_fonts/', cMapPacked: true });
                    showNotification("جاري تحميل الملف...", "info", 2000);
                    loadingTask.promise.then(doc => {
                        pdfDoc = doc; totalPages = doc.numPages;
                        loadingMessage.style.display = 'none'; pdfViewer.style.display = 'flex';
                        totalPagesNumSpan.textContent = totalPages; pageNum = 1;
                        [prevPageBtn, nextPageBtn, zoomInBtn, zoomOutBtn, translateFullDocBtn].forEach(btn => btn.disabled = false);
                        renderPage(pageNum);
                        showNotification("تم تحميل الملف بنجاح", "success", 3000);
                    }, reason => {
                        console.error('PDF loading error:', reason);
                        showNotification("فشل تحميل الملف. تأكد من أن الملف PDF صالح.", "error");
                    });
                };
                reader.readAsArrayBuffer(file);
            }

            function showNotification(message, type = 'info', duration = 3000) { notificationText.textContent = message; notification.className = `notification notification-${type}`; notification.classList.add('show'); if (duration > 0) { setTimeout(() => notification.classList.remove('show'), duration); } }
            async function getPageText(pageNum) { const page = await pdfDoc.getPage(pageNum); const textContent = await page.getTextContent(); let lastY = -1; let text = ''; textContent.items.forEach(item => { if (lastY !== -1 && Math.abs(item.transform[5] - lastY) > 5) { text += '\n'; } text += item.str + ' '; lastY = item.transform[5]; }); return text.replace(/\s+/g, ' ').trim(); }
            async function translateText(text) { const GEMINI_API_KEY = 'AIzaSyBT6VMo8wc-x68aVt_ROrQ_WXx9MTEqsA4'; const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`; if (!text || !text.trim()) { return ""; } const prompt = `You are an expert academic translator specializing in scientific and medical texts from English to Arabic. Your task is to provide a translation that is not only accurate but also adheres to the scientific context and terminology. Avoid literal translation. Ensure the final output is professional and clear. Do not add any commentary or extra text, just the pure translation of the following text:\n\n---\n\n${text}`; try { const response = await fetch(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify({ "contents": [{ "parts": [{ "text": prompt }] }] }) }); if (!response.ok) { const errorData = await response.json(); throw new Error(`Gemini Error: ${errorData.error.message || response.statusText}`); } const data = await response.json(); return data.candidates[0].content.parts[0].text; } catch (error) { console.error('Gemini Translation failed:', error); showNotification('فشل في الاتصال بخدمة الترجمة Gemini.', 'error'); throw error; } }

            async function onTranslateDocument() {
                if (!pdfDoc) return;
                const buttonIcon = translateFullDocBtn.querySelector('i'), buttonText = translateFullDocBtn.querySelector('span'), originalIconClass = buttonIcon.className;
                translateFullDocBtn.disabled = true; translateFullDocBtn.classList.add('loading'); buttonText.textContent = "جاري الترجمة...";
                progressBarContainer.style.display = 'block'; progressBar.style.width = '0%';
                translatedTextContent.innerHTML = ''; translationPanels.style.display = 'flex';
                let recurringHeader_en = "";
                try {
                    if (totalPages >= 2) {
                        const textPage1 = await getPageText(1), textPage2 = await getPageText(2);
                        const checkLength = Math.min(textPage1.length, textPage2.length, 300);
                        for (let j = 0; j < checkLength; j++) {
                            if (textPage1[j] === textPage2[j]) { recurringHeader_en += textPage1[j]; } else { break; }
                        }
                        recurringHeader_en = recurringHeader_en.trim();
                        if (recurringHeader_en.length < 10) { recurringHeader_en = ""; }
                    }
                    for (let i = 1; i <= totalPages; i++) {
                        const originalText = await getPageText(i);
                        if (!originalText.trim()) { const progress = (i / totalPages) * 100; progressBar.style.width = `${progress}%`; continue; }
                        const pageElement = document.createElement('div'); pageElement.className = 'page-translation';
                        const title = document.createElement('h4'); title.textContent = `صفحة ${i}`;
                        const content = document.createElement('div');
                        if (i === 1 && recurringHeader_en) {
                            const headerText = recurringHeader_en, bodyText = originalText.substring(headerText.length);
                            const translatedHeader = await translateText(headerText), translatedBody = await translateText(bodyText);
                            content.innerHTML = `<p class="translated-header">${translatedHeader}</p><p>${translatedBody}</p>`;
                        } else {
                            let textToTranslate = originalText;
                            if (recurringHeader_en && textToTranslate.startsWith(recurringHeader_en)) { textToTranslate = textToTranslate.substring(recurringHeader_en.length); }
                            const translatedText = await translateText(textToTranslate);
                            content.innerHTML = `<p>${translatedText}</p>`;
                        }
                        pageElement.appendChild(title); pageElement.appendChild(content); translatedTextContent.appendChild(pageElement);
                        const progress = (i / totalPages) * 100; progressBar.style.width = `${progress}%`;
                    }
                    showNotification("اكتملت ترجمة المستند بنجاح", "success");
                } catch (error) {
                    console.error('Full document translation error:', error);
                    showNotification(`حدث خطأ أثناء الترجمة: ${error.message}`, "error");
                } finally {
                    translateFullDocBtn.disabled = false; translateFullDocBtn.classList.remove('loading');
                    buttonIcon.className = originalIconClass; buttonText.textContent = "ترجمة المستند بالكامل";
                    setTimeout(() => { progressBarContainer.style.display = 'none'; }, 1000);
                }
            }

            loadPdfBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', e => e.target.files[0] && loadFile(e.target.files[0]));
            prevPageBtn.addEventListener('click', onPrevPage);
            nextPageBtn.addEventListener('click', onNextPage);
            zoomInBtn.addEventListener('click', onZoomIn);
            zoomOutBtn.addEventListener('click', onZoomOut);
            translateFullDocBtn.addEventListener('click', onTranslateDocument);
            closeTranslationBtn.addEventListener('click', () => { translationPanels.style.display = 'none'; });
            
            // --- START: UPDATED DEVICE TOGGLE LOGIC ---
            deviceToggle.addEventListener('click', () => {
                body.classList.remove(displayModes[currentModeIndex]);
                currentModeIndex = (currentModeIndex + 1) % displayModes.length;
                body.classList.add(displayModes[currentModeIndex]);
                const icon = deviceToggle.querySelector('i');
                icon.className = `fas ${modeIcons[currentModeIndex]}`;
            });
            // --- END: UPDATED DEVICE TOGGLE LOGIC ---

            themeToggle.addEventListener('click', () => {
                body.classList.remove(...themes);
                currentThemeIndex = (currentThemeIndex + 1) % themes.length;
                if (themes[currentThemeIndex]) {
                    body.classList.add(themes[currentThemeIndex]);
                }
            });
        });
    </script>
</body>
</html>
